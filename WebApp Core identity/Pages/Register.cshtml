@page
@model WebApp_Core_identity.Pages.RegisterModel
@{
 ViewData["Title"] = "Register - Fresh Farm Market";
}

<div class="container mt-5">
    <div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <h1 class="mb-4">Membership Registration</h1>
   <p class="text-muted mb-4">Join Fresh Farm Market today!</p>

     <form method="post" enctype="multipart/form-data" id="registerForm" asp-antiforgery="true">
   @Html.AntiForgeryToken()
       <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

    @* Hidden field to store the reCAPTCHA token *@
        <input type="hidden" id="captchaToken" name="captchaToken" />

       <!-- 1. Full Name -->
      <div class="mb-3">
       <label asp-for="RModel.FullName" class="form-label"></label>
 <input asp-for="RModel.FullName" class="form-control" placeholder="Enter your full name" maxlength="100" />
    <span asp-validation-for="RModel.FullName" class="text-danger"></span>
 </div>

<!-- 2. Credit Card Number -->
    <div class="mb-3">
 <label asp-for="RModel.CreditCardNo" class="form-label"></label>
      <input asp-for="RModel.CreditCardNo" type="text" class="form-control" placeholder="1234567812345678" maxlength="16" id="creditCardInput" pattern="\d{16}" />
 <small class="form-text text-muted">Your credit card will be encrypted and stored securely</small>
   <span asp-validation-for="RModel.CreditCardNo" class="text-danger"></span>
    <div id="cardValidation" class="mt-1"></div>
  </div>

        <!-- 3. Gender -->
    <div class="mb-3">
  <label asp-for="RModel.Gender" class="form-label"></label>
   <select asp-for="RModel.Gender" class="form-select" required>
   <option value="">-- Select Gender --</option>
   <option value="Male">Male</option>
     <option value="Female">Female</option>
  <option value="Other">Other</option>
      </select>
  <span asp-validation-for="RModel.Gender" class="text-danger"></span>
   </div>

<!-- 4. Mobile Number -->
   <div class="mb-3">
   <label asp-for="RModel.MobileNo" class="form-label"></label>
  <input asp-for="RModel.MobileNo" type="tel" class="form-control" placeholder="e.g. 91234567" maxlength="8" pattern="[689]\d{7}" />
   <span asp-validation-for="RModel.MobileNo" class="text-danger"></span>
 </div>

        <!-- 5. Delivery Address -->
  <div class="mb-3">
      <label asp-for="RModel.DeliveryAddress" class="form-label"></label>
<textarea asp-for="RModel.DeliveryAddress" class="form-control" rows="3" placeholder="Enter your delivery address" maxlength="500"></textarea>
  <span asp-validation-for="RModel.DeliveryAddress" class="text-danger"></span>
</div>

  <!-- 6. Email Address -->
   <div class="mb-3">
     <label asp-for="RModel.Email" class="form-label"></label>
 <input asp-for="RModel.Email" type="email" class="form-control" placeholder="your.email@example.com" maxlength="100" />
 <span asp-validation-for="RModel.Email" class="text-danger"></span>
   </div>

      <!-- 7. Password -->
 <div class="mb-3">
   <label asp-for="RModel.Password" class="form-label"></label>
     <input asp-for="RModel.Password" type="password" class="form-control" id="passwordInput" />
        <div id="passwordStrength" class="mt-2"></div>
 <small class="form-text text-muted">Min 12 characters with uppercase, lowercase, number and special character</small>
       <span asp-validation-for="RModel.Password" class="text-danger"></span>
    </div>

        <!-- 8. Confirm Password -->
<div class="mb-3">
        <label asp-for="RModel.ConfirmPassword" class="form-label"></label>
<input asp-for="RModel.ConfirmPassword" type="password" class="form-control" />
   <span asp-validation-for="RModel.ConfirmPassword" class="text-danger"></span>
 </div>

     <!-- 9. Photo -->
<div class="mb-3">
  <label asp-for="RModel.Photo" class="form-label"></label>
  <input asp-for="RModel.Photo" type="file" class="form-control" accept=".jpg,.jpeg" id="photoInput" />
   <small class="form-text text-muted">Only .JPG files allowed (max 5MB)</small>
     <span asp-validation-for="RModel.Photo" class="text-danger"></span>
  <div id="photoPreview" class="mt-2"></div>
       </div>

    <!-- 10. About Me -->
        <div class="mb-3">
       <label asp-for="RModel.AboutMe" class="form-label"></label>
 <textarea asp-for="RModel.AboutMe" class="form-control" rows="4" placeholder="Tell us about yourself..." maxlength="1000"></textarea>
   <span asp-validation-for="RModel.AboutMe" class="text-danger"></span>
</div>

  <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Register</button>
 </div>

<div class="mt-3 text-center">
 <p>Already have an account? <a asp-page="/Login">Login here</a></p>
     </div>
       </form>
  </div>
 </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

@* Load Google reCAPTCHA Library *@
    <script src="https://www.google.com/recaptcha/api.js?render=6LcgHEcsAAAAAJyVNle2SoK4Qf2Q4mBf6m9t_yG5"></script>

<script type="text/javascript">
  // === XSS PREVENTION: Sanitize function ===
    function sanitizeHtml(text) {
    var div = document.createElement('div');
      div.textContent = text;
       return div.innerHTML;
   }

// === CLIENT-SIDE VALIDATION ===
 
   // Password strength checker
  document.getElementById('passwordInput').addEventListener('input', function() {
    var password = this.value;
 var strengthDiv = document.getElementById('passwordStrength');
 
 var strength = 0;
      var feedback = [];
  
     if (password.length >= 12) strength++;
  else feedback.push('at least 12 characters');
  
        if (/[a-z]/.test(password)) strength++;
else feedback.push('a lowercase letter');
    
     if (/[A-Z]/.test(password)) strength++;
     else feedback.push('an uppercase letter');
    
        if (/\d/.test(password)) strength++;
  else feedback.push('a number');
        
 if (/[@@$!%*?&#]/.test(password)) strength++;
else feedback.push('a special character (@@$!%*?&#)');
   
     if (strength === 5) {
   strengthDiv.innerHTML = '<span class="badge bg-success">Strong Password</span>';
     } else if (strength >= 3) {
    strengthDiv.innerHTML = '<span class="badge bg-warning text-dark">Moderate - Missing: ' + sanitizeHtml(feedback.join(', ')) + '</span>';
 } else {
   strengthDiv.innerHTML = '<span class="badge bg-danger">Weak - Need: ' + sanitizeHtml(feedback.join(', ')) + '</span>';
 }
 });

   // Credit card validation with Luhn algorithm
     document.getElementById('creditCardInput').addEventListener('input', function() {
    this.value = this.value.replace(/\D/g, '');
  
   if (this.value.length === 16) {
      if (validateLuhn(this.value)) {
         document.getElementById('cardValidation').innerHTML = '<small class="text-success">✓ Valid card number</small>';
  } else {
 document.getElementById('cardValidation').innerHTML = '<small class="text-danger">✗ Invalid card number</small>';
   }
   } else {
  document.getElementById('cardValidation').innerHTML = '';
      }
    });

function validateLuhn(cardNumber) {
      var sum = 0;
    var alternate = false;
     
      for (var i = cardNumber.length - 1; i >= 0; i--) {
  var digit = parseInt(cardNumber[i]);
 
    if (alternate) {
  digit *= 2;
    if (digit > 9) digit -= 9;
  }
     
 sum += digit;
      alternate = !alternate;
     }
      
return sum % 10 === 0;
        }

   // Photo validation with preview
 document.getElementById('photoInput').addEventListener('change', function() {
     var file = this.files[0];
 var previewDiv = document.getElementById('photoPreview');
        
  if (file) {
       // Validate extension
            var ext = file.name.split('.').pop().toLowerCase();
  if (ext !== 'jpg' && ext !== 'jpeg') {
    alert('Only .JPG files are allowed');
    this.value = '';
 previewDiv.innerHTML = '';
  return;
    }
    
       // Validate size (5MB)
   if (file.size > 5 * 1024 * 1024) {
     alert('File size must not exceed 5MB');
      this.value = '';
       previewDiv.innerHTML = '';
  return;
   }
      
  // Show preview
       var reader = new FileReader();
      reader.onload = function(e) {
 previewDiv.innerHTML = '<img src="' + e.target.result + '" class="img-thumbnail mt-2" style="max-width: 200px;" />';
   };
       reader.readAsDataURL(file);
         }
  });

    // === RECAPTCHA GENERATION ===
    grecaptcha.ready(function() {
      grecaptcha.execute('6LcgHEcsAAAAAJyVNle2SoK4Qf2Q4mBf6m9t_yG5', {action: 'register'})
       .then(function(token) {
     document.getElementById('captchaToken').value = token;
       });
});

        // Form submission validation
 document.getElementById('registerForm').addEventListener('submit', function(e) {
   var submitBtn = document.getElementById('submitBtn');
 submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registering...';
 });
 </script>
}