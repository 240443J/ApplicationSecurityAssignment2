@page
@model WebApp_Core_identity.Pages.ChangePasswordModel
@{
    ViewData["Title"] = "Change Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
     <div class="col-md-6">
   <h1 class="mb-4"><i class="bi bi-key"></i> Change Password</h1>

   @if (!string.IsNullOrEmpty(Model.StatusMessage))
 {
   <div class="alert alert-success alert-dismissible fade show" role="alert">
       <i class="bi bi-check-circle"></i> @Model.StatusMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
   }

 @* PASSWORD EXPIRY WARNING *@
  @if (!string.IsNullOrEmpty(Model.PasswordExpiryWarning))
        {
       var alertClass = Model.DaysUntilExpiry == 0 ? "alert-danger" : "alert-warning";
  <div class="alert @alertClass alert-dismissible fade show" role="alert">
       <i class="bi bi-exclamation-triangle-fill"></i>
     <strong>@Model.PasswordExpiryWarning</strong>
     @if (Model.DaysUntilExpiry > 0)
          {
  <p class="mb-0 mt-2"><small>Please change your password immediately to maintain account security.</small></p>
      }
           else
 {
     <p class="mb-0 mt-2"><strong>You must change your password now to continue using your account.</strong></p>
}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
    }

  <div class="card shadow-sm">
   <div class="card-body">
      <form method="post" asp-antiforgery="true">
     @Html.AntiForgeryToken()
    <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

      <div class="mb-3">
    <label asp-for="CPModel.CurrentPassword" class="form-label"></label>
     <div class="input-group">
  <input asp-for="CPModel.CurrentPassword" type="password" class="form-control" id="currentPasswordField" />
         <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
   <i class="bi bi-eye" id="currentEyeIcon"></i>
   </button>
 </div>
 <span asp-validation-for="CPModel.CurrentPassword" class="text-danger"></span>
        </div>

     <div class="mb-3">
     <label asp-for="CPModel.NewPassword" class="form-label"></label>
<div class="input-group">
 <input asp-for="CPModel.NewPassword" type="password" class="form-control" id="newPasswordField" />
     <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
    <i class="bi bi-eye" id="newEyeIcon"></i>
   </button>
 </div>
  <div id="passwordStrength" class="mt-2"></div>
 <small class="form-text text-muted">Min 12 characters with uppercase, lowercase, number and special character</small>
     <span asp-validation-for="CPModel.NewPassword" class="text-danger"></span>
   </div>

 <div class="mb-3">
  <label asp-for="CPModel.ConfirmPassword" class="form-label"></label>
  <input asp-for="CPModel.ConfirmPassword" type="password" class="form-control" />
 <span asp-validation-for="CPModel.ConfirmPassword" class="text-danger"></span>
   </div>

   <div class="alert alert-info" role="alert">
     <i class="bi bi-info-circle"></i> <strong>Password Requirements:</strong>
   <ul class="mb-0 mt-2">
        <li>At least 12 characters</li>
   <li>One uppercase letter</li>
    <li>One lowercase letter</li>
<li>One number</li>
  <li>One special character (&#64;$!%*?&amp;#)</li>
 <li>Cannot reuse last 2 passwords</li>
        <li><strong>Cannot change within 1 minute of last change</strong></li>
          <li><strong>Must change password every 1 minute</strong></li>
     </ul>
   </div>

      <div class="d-grid gap-2">
 <button type="submit" class="btn btn-primary btn-lg">
    <i class="bi bi-check-circle"></i> Change Password
      </button>
        <a asp-page="/Index" class="btn btn-outline-secondary">
     <i class="bi bi-arrow-left"></i> Back to Profile
     </a>
 </div>
    </form>
  </div>
   </div>
     </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

 <script type="text/javascript">
   // Password visibility toggles
        document.getElementById('toggleCurrentPassword').addEventListener('click', function() {
var field = document.getElementById('currentPasswordField');
 var icon = document.getElementById('currentEyeIcon');
 if (field.type === 'password') {
    field.type = 'text';
   icon.className = 'bi bi-eye-slash';
    } else {
 field.type = 'password';
  icon.className = 'bi bi-eye';
   }
});

document.getElementById('toggleNewPassword').addEventListener('click', function() {
   var field = document.getElementById('newPasswordField');
 var icon = document.getElementById('newEyeIcon');
   if (field.type === 'password') {
    field.type = 'text';
   icon.className = 'bi bi-eye-slash';
 } else {
    field.type = 'password';
     icon.className = 'bi bi-eye';
  }
 });

 // Password strength checker
        document.getElementById('newPasswordField').addEventListener('input', function() {
   var password = this.value;
   var strengthDiv = document.getElementById('passwordStrength');
    
var strength = 0;
   var feedback = [];
     
 if (password.length >= 12) strength++;
else feedback.push('at least 12 characters');
  
   if (/[a-z]/.test(password)) strength++;
 else feedback.push('a lowercase letter');
      
if (/[A-Z]/.test(password)) strength++;
    else feedback.push('an uppercase letter');
 
    if (/\d/.test(password)) strength++;
 else feedback.push('a number');
   
 if (/[@@$!%*?&#]/.test(password)) strength++;
   else feedback.push('a special character (@@$!%*?&#)');
       
     if (strength === 5) {
   strengthDiv.innerHTML = '<span class="badge bg-success">Strong Password</span>';
      } else if (strength >= 3) {
var div = document.createElement('div');
    div.textContent = feedback.join(', ');
  strengthDiv.innerHTML = '<span class="badge bg-warning text-dark">Moderate - Missing: ' + div.innerHTML + '</span>';
 } else {
   var div2 = document.createElement('div');
 div2.textContent = feedback.join(', ');
 strengthDiv.innerHTML = '<span class="badge bg-danger">Weak - Need: ' + div2.innerHTML + '</span>';
       }
    });
    </script>
}
