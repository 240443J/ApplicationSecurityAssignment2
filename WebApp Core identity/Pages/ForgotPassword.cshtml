@page
@model WebApp_Core_identity.Pages.ForgotPasswordModel
@{
 ViewData["Title"] = "Forgot Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
     <div class="card shadow">
<div class="card-header bg-primary text-white">
          <h2 class="mb-0"><i class="bi bi-key"></i> Forgot Password</h2>
    </div>
       <div class="card-body">
      
            @if (!string.IsNullOrEmpty(Model.StatusMessage))
        {
      <div class="alert alert-info">
        @Model.StatusMessage
    </div>
      }

      <div class="alert alert-info">
         <i class="bi bi-info-circle"></i>
        <strong>Need to reset your password?</strong>
  <p class="mb-0">Enter your email address and we'll send you a secure link to reset your password.</p>
      </div>

     <form method="post" id="forgotPasswordForm">
  <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

   @* Hidden field to store the reCAPTCHA token *@
      <input type="hidden" id="captchaToken" name="captchaToken" />

 <div class="mb-3">
         <label asp-for="Email" class="form-label">
      <i class="bi bi-envelope"></i> Email Address
  </label>
   <input asp-for="Email" 
 type="email" 
       class="form-control form-control-lg" 
     placeholder="your.email@example.com"
required 
 maxlength="100" />
       <span asp-validation-for="Email" class="text-danger"></span>
  </div>

 <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
     <i class="bi bi-send"></i> Send Reset Link
 </button>
        </form>

     <hr class="my-4">

       <div class="text-center">
 <p class="mb-2">
           <i class="bi bi-arrow-left"></i>
   <a asp-page="/Login" class="text-decoration-none">Back to Login</a>
    </p>
       <p class="text-muted small">
     <i class="bi bi-shield-check"></i> 
      The reset link will expire in 30 minutes for security.
  </p>
 </div>
 </div>
  </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    @* Load Google reCAPTCHA Library *@
    <script src="https://www.google.com/recaptcha/api.js?render=6LcgHEcsAAAAAJyVNle2SoK4Qf2Q4mBf6m9t_yG5"></script>

    <script type="text/javascript">
  // === RECAPTCHA GENERATION ===
    grecaptcha.ready(function() {
            grecaptcha.execute('6LcgHEcsAAAAAJyVNle2SoK4Qf2Q4mBf6m9t_yG5', {action: 'forgot_password'})
      .then(function(token) {
  document.getElementById('captchaToken').value = token;
  console.log('reCAPTCHA token generated:', token.substring(0, 20) + '...');
     });
  });

        // Form submission handling
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
 var submitBtn = document.getElementById('submitBtn');
          var email = document.querySelector('input[name="Email"]').value;

       // Debug logging
     console.log('Form submitting...');
  console.log('Email:', email);
 console.log('Form action:', this.action || 'default (current page)');
         console.log('Form method:', this.method);

      // Client-side email validation
      var emailPattern = new RegExp('^[a-zA-Z0-9._%+-]+' + String.fromCharCode(64) + '[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
        if (!emailPattern.test(email)) {
       e.preventDefault();
       alert('Please enter a valid email address');
   return false;
}

    // Check if captcha token exists
            var captchaToken = document.getElementById('captchaToken').value;
    if (!captchaToken) {
       e.preventDefault();
    alert('Security verification failed. Please refresh the page and try again.');
         return false;
            }

       // Disable button and show loading state
   submitBtn.disabled = true;
         submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending...';
      });
    </script>
}
