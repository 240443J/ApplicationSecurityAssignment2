@page
@model WebApp_Core_identity.Pages.ResetPasswordModel
@{
    ViewData["Title"] = "Reset Password";
}

<div class="container mt-5">
<div class="row justify-content-center">
 <div class="col-md-6">
       <div class="card shadow">
        <div class="card-header @(Model.TokenValid ? "bg-primary" : "bg-danger") text-white">
   <h2 class="mb-0">
        <i class="bi @(Model.TokenValid ? "bi-shield-lock" : "bi-exclamation-triangle")"></i>
    Reset Password
    </h2>
       </div>
      <div class="card-body">
        @if (!Model.TokenValid)
        {
       <div class="alert alert-danger">
       <h4><i class="bi bi-x-circle"></i> Invalid or Expired Link</h4>
   <p><strong>@Model.ErrorMessage</strong></p>
    <p class="mb-3">This password reset link is no longer valid. This could be because:</p>
         <ul>
      <li>The link has expired (links are valid for 30 minutes)</li>
           <li>The link has already been used</li>
        <li>The link is malformed or incomplete</li>
      </ul>
       <hr>
       <div class="d-grid gap-2">
     <a asp-page="/ForgotPassword" class="btn btn-primary">
        <i class="bi bi-arrow-repeat"></i> Request New Reset Link
       </a>
        <a asp-page="/Login" class="btn btn-outline-secondary">
   <i class="bi bi-box-arrow-in-right"></i> Back to Login
  </a>
       </div>
   </div>
        }
  else
          {
    <div class="alert alert-success">
    <i class="bi bi-check-circle"></i>
  <strong>Your reset link is valid!</strong>
        <p class="mb-0">Please enter your new password below.</p>
   </div>

  <form method="post" asp-antiforgery="true" id="resetPasswordForm">
        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

 <input type="hidden" asp-for="Token" />
      <input type="hidden" asp-for="Email" />

   <div class="mb-3">
      <label asp-for="NewPassword" class="form-label">
     <i class="bi bi-key"></i> New Password
       </label>
   <div class="input-group">
      <input asp-for="NewPassword" 
     type="password" 
      class="form-control" 
    id="newPasswordField"
required 
       minlength="12" />
       <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
    <i class="bi bi-eye" id="eyeIcon1"></i>
 </button>
  </div>
 <div id="passwordStrength" class="mt-2"></div>
<small class="form-text text-muted">
          <i class="bi bi-info-circle"></i>
     Min 12 characters with uppercase, lowercase, number and special character
        </small>
        </div>

    <div class="mb-3">
         <label asp-for="ConfirmPassword" class="form-label">
   <i class="bi bi-key-fill"></i> Confirm Password
    </label>
   <div class="input-group">
 <input asp-for="ConfirmPassword" 
type="password" 
     class="form-control" 
        id="confirmPasswordField"
     required />
   <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
     <i class="bi bi-eye" id="eyeIcon2"></i>
     </button>
 </div>
   </div>

<div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Password Requirements:</strong>
   <ul class="mb-0 mt-2">
  <li>Minimum 12 characters long</li>
   <li>At least one uppercase letter (A-Z)</li>
       <li>At least one lowercase letter (a-z)</li>
     <li>At least one number (0-9)</li>
<li>At least one special character (@@$!%*?&#)</li>
   <li>Cannot reuse your last 2 passwords</li>
      </ul>
   </div>

 <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
     <i class="bi bi-shield-check"></i> Reset Password
   </button>
</form>

    <hr class="my-4">

<div class="text-center">
<a asp-page="/Login" class="text-decoration-none">
      <i class="bi bi-arrow-left"></i> Back to Login
 </a>
   </div>
     }
       </div>
      </div>
     </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
 <script type="text/javascript">
        // Password visibility toggles
   document.getElementById('toggleNewPassword')?.addEventListener('click', function() {
       var field = document.getElementById('newPasswordField');
    var icon = document.getElementById('eyeIcon1');
    if (field.type === 'password') {
    field.type = 'text';
     icon.className = 'bi bi-eye-slash';
 } else {
        field.type = 'password';
    icon.className = 'bi bi-eye';
}
     });

 document.getElementById('toggleConfirmPassword')?.addEventListener('click', function() {
       var field = document.getElementById('confirmPasswordField');
       var icon = document.getElementById('eyeIcon2');
       if (field.type === 'password') {
       field.type = 'text';
icon.className = 'bi bi-eye-slash';
 } else {
    field.type = 'password';
       icon.className = 'bi bi-eye';
       }
 });

        // Password strength checker
        document.getElementById('newPasswordField')?.addEventListener('input', function() {
      var password = this.value;
    var strengthDiv = document.getElementById('passwordStrength');
 
    var strength = 0;
   var feedback = [];

 if (password.length >= 12) strength++;
    else feedback.push('at least 12 characters');

  if (/[a-z]/.test(password)) strength++;
  else feedback.push('a lowercase letter');

  if (/[A-Z]/.test(password)) strength++;
  else feedback.push('an uppercase letter');

        if (/\d/.test(password)) strength++;
       else feedback.push('a number');

  if (/[@@$!%*?&#]/.test(password)) strength++;
    else feedback.push('a special character');

     if (strength === 5) {
  strengthDiv.innerHTML = '<div class="alert alert-success py-2"><i class="bi bi-check-circle"></i> <strong>Strong Password!</strong></div>';
  } else if (strength >= 3) {
   strengthDiv.innerHTML = '<div class="alert alert-warning py-2"><i class="bi bi-exclamation-triangle"></i> <strong>Moderate</strong> - Missing: ' + feedback.join(', ') + '</div>';
   } else {
  strengthDiv.innerHTML = '<div class="alert alert-danger py-2"><i class="bi bi-x-circle"></i> <strong>Weak</strong> - Need: ' + feedback.join(', ') + '</div>';
   }
   });

        // Form submission
  document.getElementById('resetPasswordForm')?.addEventListener('submit', function(e) {
 var submitBtn = document.getElementById('submitBtn');
       var newPassword = document.getElementById('newPasswordField').value;
   var confirmPassword = document.getElementById('confirmPasswordField').value;

    if (newPassword !== confirmPassword) {
      e.preventDefault();
    alert('Passwords do not match!');
    return false;
 }

       submitBtn.disabled = true;
       submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Resetting Password...';
   });
    </script>
}
